<% content_for :title, @track.title %>

<%# TODO make it responsive %>
<div class="flex flex-col justify-center items-center gap-12 w-full">
  <section class="flex justify-start items-stretch gap-8 w-full">
    <div class="min-w-50 min-h-50 w-50 h-50">
      <%= render Tracks::PlayableCoverPhoto.new(track: @track, size: 50) %>
    </div>

    <div class="flex-1 flex flex-col justify-between items-start">
      <div class="flex-1">
        <h1 class="text-2xl truncate font-bold"><%= @track.title %></h1>
        <div class="flex justify-start items-center gap-3 text-[0.6rem] text-secondary-txt w-full mt-1">
          <%= render partial: "tracks/track_data", locals: { track: @track, icon_size: "5" } %>
        </div>
        <p class="text-xs mt-2"><%= @track.description %></p>
      </div>
      <div class="flex flex-col justify-center items-start gap-2 w-full">
        <div class="flex justify-start items-center gap-2">
          <% @track.tags.each do |tag| %>
            <%= render TagComponent.new(name: tag.name) %>
          <% end %>
        </div>
        <div class="flex justify-start items-stretch gap-2">
          <%# TODO might look better to show the cheapest license price, whatevs %>
          <button class="button px-2 py-1.5">
            <%= icon "shopping-bag", class: "mr-1" %>
            <p class="text-sm font-light"><%= @track.cheapest_price %></p>
          </button>

          <%# TODO add tool tips for the following %>
          <% if current_user %>
            <%= button_to track_heart_path(@track), form_class: "track-show-icon-only-btn",
              class: "flex justify-center items-center w-full h-full",
              method: current_user.hearted?(@track) ? :delete : :post,
              data: {
                controller: "like-button",
                like_button_user_liked_value: current_user.hearted?(@track),
                action: "click->like-button#toggle",
              } do %>
              <%= icon "heart", variant: "filled", class: "text-accent w-5 h-5 cursor-pointer hidden",
                data: { like_button_target: "liked" } %>
              <%= icon "heart", variant: "outline", class: "text-accent w-5 h-5 cursor-pointer hidden",
                data: { like_button_target: "notLiked" } %>
            <% end %>
          <% else %>
            <%= link_to auth_prompt_modal_path, class: "track-show-icon-only-btn", data: { turbo_stream: true } do %>
              <%= icon "heart", class: "text-accent w-5 h-5 cursor-pointer" %>
            <% end %>
          <% end %>

          <%= link_to download_track_free_path(@track), target: "_blank", rel: "noopener", class: "track-show-icon-only-btn" do %>
            <%= icon "download", class: "text-accent" %>
          <% end %>

          <button class="track-show-icon-only-btn">
            <%= icon "share", class: "text-accent" %>
          </button>

          <%= link_to track_more_info_modal_path(@track), class: "track-show-icon-only-btn", data: { turbo_stream: true } do %>
            <%= icon "library", class: "text-accent" %>
          <% end %>

          <% if current_user && current_user.admin? %>
            <%= link_to edit_admin_track_path(@track), class: "track-show-icon-only-btn" do %>
              <%= icon "pencil", class: "text-accent" %>
            <% end %>
          <% end %>
        </div>
      </div>
    </div>
  </section>
  <section class="w-full">
    <h2 class="font-bold text-lg mb-2"><%= t("track.licensing") %></h2>

    <% if @licenses.any? %>
      <div>
        <ul class="grid grid-cols-3 gap-x-2 gap-y-2 mb-4 w-full text-sm font-medium"
          id="default-styled-tab" data-tabs-toggle="#license-tab-contents" role="tablist"
          data-tabs-active-classes="border-accent"
          data-tabs-inactive-classes="border-secondary-txt/30">
          <% @licenses.each_with_index do |license, i| %>
            <li role="presentation">
              <button id=<%= dom_id(license, :tab) %>
                class="<%= "
                  flex flex-col justify-start items-start gap-1 w-full p-3 border-1 rounded-xl cursor-pointer
                  #{i == 0 ? "border-accent" : "border-secondary-txt/30"}
                " %>"
                data-tabs-target="#<%= dom_id(license) %>"
                type="button" role="tab" aria-controls="<%= dom_id(license) %>" aria-selected="false">
                <p class="text-sm"><%= license.title %></p>
                <p class="text-[0.7rem] font-light"><%= "#{license.price.format} #{license.currency}" %></p>
                <p class="text-[0.6rem] text-secondary-txt"><%= track_files_delivered(license) %></p>
              </button>
            </li>
          <% end %>
        </ul>
      </div>
      <div id="license-tab-contents">
        <% @licenses.each do |license| %>
          <div class="hidden" id="<%= dom_id(license) %>" role="tabpanel" aria-labelledby=<%= dom_id(license, :tab) %>>
            <p class="text-sm font-light mb-4"><%= "#{license.title} (#{license.price.format})" %></p>
            <% contract = license.contract %>
            <ul class="grid grid-cols-3 w-full gap-x-4 gap-y-2">
              <% [
                {
                  phrase: t("track.show.licensing.allow_music_recording"),
                  icon: "microphone"
                },
                {
                  phrase: t("track.show.licensing.distribution_copies",
                    copies: contract[:distribution_copies].presence || t("track.show.licensing.unlimited")),
                  icon: "gavel"
                },
                {
                  phrase: t("track.show.licensing.online_audio_streams",
                    streams: contract[:streams_allowed].presence || t("track.show.licensing.unlimited")),
                  icon: "access-point"
                },
                {
                  phrase: t("track.show.licensing.music_videos",
                    videos: contract[:monetized_videos].presence || t("track.show.licensing.unlimited")),
                  icon: "video"
                },
                {
                  phrase: t("track.show.licensing.#{contract[:allow_profitable_performances] ? "" : "not_" }for_profit_live_performances"),
                  icon: "microphone-2"
                },
                {
                  phrase: t("track.show.licensing.has_radio_broadcasting_rights",
                    stations: contract[:has_broadcasting_rights] ? (contract[:radio_stations_allowed].presence || t("track.show.licensing.unlimited")) : 0),
                  icon: "radio"
                }
              ].each do |data| %>
                <li class="flex justify-start items-center gap-2 text-secondary-txt text-xs">
                  <%= icon data[:icon], class: "w-4 h-4 aspect-square" %>
                  <p class="text-[0.6rem]"><%= data[:phrase] %></p>
                </li>
              <% end %>
            </ul>
          </div>
        <% end %>
      </div>
    <% else %>
      <p class="w-full flex justify-center items-center text-secondary-txt italic font-light py-2 text-xs">
        <%= t("track.show.licensing.no_licenses") %>
      </p>
    <% end %>
  </section>
  <section class="w-full">
    <h2 class="font-bold text-lg mb-2"><%= t("track.similar_tracks") %></h2>
    <%= render Tracks::ListComponent.new(
      tracks: @similar_tracks,
      current_user:,
      options: { render_message_if_empty: false }
    ) %>
  </section>
  <section id="comments" class="w-full">
    <h2 class="font-bold text-lg mb-2"><%= t("label.comments") %></h2>
    <%= render Comments::FormComponent.new(entity: @track, current_user:) %>
    <div>
      <%= turbo_frame_tag "track-comments", target: "_top", data: { turbo_temporary: false } do %>
        <%= render Comments::ListComponent.new(comments: @comments, current_user:) %>
      <% end %>

      <%= render "shared/load_more", pagy: @pagy %>
    </div>
  </section>
</div>
